name: Release to NuGet

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: false
        default: ''
      force_pack:
        description: 'Force pack all projects (ignore change detection)'
        required: false
        default: false
        type: boolean
   
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      NuGetDirectory: ${{ github.workspace}}/nuget
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0 # Required for GitVersion
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0.9.7
      with:
        versionSpec: '5.x'
    - name: Determine Version
      uses: gittools/actions/gitversion/execute@v0.9.7
      id: gitversion
    - name: Detect Changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          azure:
            - 'src/TestingCommons.Azure/**'
          core:
            - 'src/TestingCommons.Core/**'
          mongodb:
            - 'src/TestingCommons.MongoDb/**'
          newrelic:
            - 'src/TestingCommons.NewRelic/**'
          reqnroll:
            - 'src/TestingCommons.Reqnroll/**'
          rabbitmq:
            - 'src/TestingCommons.RabbitMq/**'
          restapiclient:
            - 'src/TestingCommons.RestApiClient/**'
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v1
    - name: Build
      run: dotnet build src/TestingCommons.sln -c Release 
    - name: Test
      run: dotnet test src/TestingCommons.UnitTests/TestingCommons.UnitTests.csproj -c Release --no-build
    - name: Pack TestingCommons.Azure
      if: steps.changes.outputs.azure == 'true' || inputs.force_pack == true
      run: dotnet pack src/TestingCommons.Azure/TestingCommons.Azure.csproj -c Release --no-build --output ${{ env.NuGetDirectory }} -p:PackageVersion=${{ steps.gitversion.outputs.nuGetVersionV2 }}
    - name: Pack TestingCommons.Core
      if: steps.changes.outputs.core == 'true' || inputs.force_pack == true
      run: dotnet pack src/TestingCommons.Core/TestingCommons.Core.csproj -c Release --no-build --output ${{ env.NuGetDirectory }} -p:PackageVersion=${{ steps.gitversion.outputs.nuGetVersionV2 }}
    - name: Pack TestingCommons.MongoDb
      if: steps.changes.outputs.mongodb == 'true' || inputs.force_pack == true
      run: dotnet pack src/TestingCommons.MongoDb/TestingCommons.MongoDb.csproj -c Release --no-build --output ${{ env.NuGetDirectory }} -p:PackageVersion=${{ steps.gitversion.outputs.nuGetVersionV2 }}
    - name: Pack TestingCommons.NewRelic
      if: steps.changes.outputs.newrelic == 'true' || inputs.force_pack == true
      run: dotnet pack src/TestingCommons.NewRelic/TestingCommons.NewRelic.csproj -c Release --no-build --output ${{ env.NuGetDirectory }} -p:PackageVersion=${{ steps.gitversion.outputs.nuGetVersionV2 }}
    - name: Pack TestingCommons.Reqnroll
      if: steps.changes.outputs.reqnroll == 'true' || inputs.force_pack == true
      run: dotnet pack src/TestingCommons.Reqnroll/TestingCommons.Reqnroll.csproj -c Release --no-build --output ${{ env.NuGetDirectory }} -p:PackageVersion=${{ steps.gitversion.outputs.nuGetVersionV2 }}
    - name: Pack TestingCommons.RabbitMq
      if: steps.changes.outputs.rabbitmq == 'true' || inputs.force_pack == true
      run: dotnet pack src/TestingCommons.RabbitMq/TestingCommons.RabbitMq.csproj -c Release --no-build --output ${{ env.NuGetDirectory }} -p:PackageVersion=${{ steps.gitversion.outputs.nuGetVersionV2 }}
    - name: Pack TestingCommons.RestApiClient
      if: steps.changes.outputs.restapiclient == 'true' || inputs.force_pack == true
      run: dotnet pack src/TestingCommons.RestApiClient/TestingCommons.RestApiClient.csproj -c Release --no-build --output ${{ env.NuGetDirectory }} -p:PackageVersion=${{ steps.gitversion.outputs.nuGetVersionV2 }}
    - name: Check for packages
      id: check_packages
      run: |
        if [ -d "${{ env.NuGetDirectory }}" ] && [ "$(ls -A ${{ env.NuGetDirectory }}/*.nupkg 2>/dev/null | wc -l)" -gt 0 ]; then
          echo "has_packages=true" >> $GITHUB_OUTPUT
          echo "Found packages to publish"
        else
          echo "has_packages=false" >> $GITHUB_OUTPUT
          echo "No packages found to publish"
        fi
    - name: Publish NuGet package
      if: steps.check_packages.outputs.has_packages == 'true'
      shell: pwsh
      run: |
        foreach($file in (Get-ChildItem "${{ env.NuGetDirectory }}" -Recurse -Include *.nupkg)) {
            dotnet nuget push $file --api-key "${{ secrets.nuget_api_key }}" --source https://api.nuget.org/v3/index.json --skip-duplicate
        }
